import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import plotly.express as px

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢", layout="wide")

st.markdown("""
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; }
    </style>
""", unsafe_allow_html=True)

# --- 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
conn = st.connection("gsheets", type=GSheetsConnection)

def load_data():
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Tab ‡∏ä‡∏∑‡πà‡∏≠ masters ‡πÅ‡∏•‡∏∞ research
        df_m = conn.read(worksheet="masters", ttl="5m") 
        df_r = conn.read(worksheet="research", ttl=0)
        return df_m, df_r
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ: {e}")
        st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Å: 1. ‡∏ä‡∏∑‡πà‡∏≠ Tab ‡πÉ‡∏ô Google Sheets ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 'masters' ‡πÅ‡∏•‡∏∞ 'research' | 2. ‡πÉ‡∏™‡πà URL ‡πÉ‡∏ô Secrets ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?")
        st.stop()

df_master, df_research = load_data()

# --- 3. ‡∏£‡∏∞‡∏ö‡∏ö Login ---
ADMIN_USER = st.secrets.get("admin_user", "admin")
ADMIN_PWD = st.secrets.get("admin_pwd", "password123")

if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False

def login_form():
    with st.sidebar:
        st.subheader("üîë ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô")
        user = st.text_input("Username")
        pwd = st.text_input("Password", type="password")
        if st.button("Login"):
            if user == ADMIN_USER and pwd == ADMIN_PWD:
                st.session_state['logged_in'] = True
                st.rerun()
            else: st.error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

# --- 4. ‡πÄ‡∏°‡∏ô‡∏π ---
if not st.session_state['logged_in']:
    login_form()
    menu = st.sidebar.radio("‡πÄ‡∏°‡∏ô‡∏π", ["üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ KPI"])
else:
    if st.sidebar.button("Logout"):
        st.session_state['logged_in'] = False
        st.rerun()
    menu = st.sidebar.radio("‡πÄ‡∏°‡∏ô‡∏π", ["üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ KPI", "‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô"])

# --- 5. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ KPI) ---
if menu == "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ KPI":
    st.title("üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢")
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì KPI (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö)
    all_progs = df_master["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"].unique()
    df_all_progs = pd.DataFrame(all_progs, columns=["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"])
    
    # ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    res_sum = df_research.groupby("‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô")["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"].sum().reset_index()
    # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô
    df_merged = df_master.merge(res_sum, left_on="Name-surname", right_on="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", how="left").fillna(0)
    
    prog_report = df_merged.groupby(["‡∏Ñ‡∏ì‡∏∞", "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"])["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"].sum().reset_index()
    # (‡∏ô‡∏¥‡∏ô‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£ KPI 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
    prog_report["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"] = prog_report["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"] # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    prog_report["‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î"] = prog_report["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"].apply(lambda x: max(0, 5-x))

    # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á 5.0
    fig = px.bar(prog_report, x="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", y="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", orientation='h', 
                 title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI ‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", color_discrete_sequence=['#2ecc71'])
    fig.add_vline(x=5.0, line_dash="dash", line_color="red", annotation_text="‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô (5.0)")
    st.plotly_chart(fig, use_container_width=True)
    st.dataframe(prog_report, use_container_width=True)

# --- 6. ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
elif menu == "‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô":
    st.title("‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Google Sheets")
    with st.form("add_form", clear_on_submit=True):
        title = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á")
        year = st.number_input("‡∏õ‡∏µ (‡∏û.‡∏®.)", 2560, 2600, 2567)
        journal = st.selectbox("‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£", ["TCI1", "TCI2", "Scopus Q1", "Scopus Q2"])
        author = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", df_master["Name-surname"].unique())
        
        if st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"):
            score_map = {"TCI1": 0.8, "TCI2": 0.6, "Scopus Q1": 1.0, "Scopus Q2": 1.0}
            new_row = pd.DataFrame([{
                "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á": title, "‡∏õ‡∏µ": year, "‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£": journal, 
                "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": score_map[journal], "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô": author, "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å": ""
            }])
            # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets
            updated_df = pd.concat([df_research, new_row], ignore_index=True)
            conn.update(worksheet="research", data=updated_df)
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            st.rerun()
