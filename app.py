import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import plotly.express as px

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢", layout="wide")

# --- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
conn = st.connection("gsheets", type=GSheetsConnection)

@st.cache_data(ttl=0)
def load_data_robust():
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        all_sheets = conn.read()
        
        # 1. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô
        df_m = all_sheets.get("masters")
        df_r = all_sheets.get("research")
        
        # 2. ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏∑‡∏≠ masters, ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Ñ‡∏∑‡∏≠ research)
        sheet_names = list(all_sheets.keys())
        if df_m is None:
            df_m = all_sheets[sheet_names[0]]
        if df_r is None:
            df_r = all_sheets[sheet_names[1]]
            
        # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        df_m.columns = df_m.columns.str.strip()
        df_r.columns = df_r.columns.str.strip()
        
        return df_m, df_r
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: {e}")
        st.stop()

df_master, df_research = load_data_robust()

# --- ‡πÄ‡∏°‡∏ô‡∏π Sidebar ---
with st.sidebar:
    st.title("üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢")
    menu = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π", ["üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI", "‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô"])

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤) ---
if menu == "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI":
    st.title("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ KPI ‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£")
    
    # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£' ‡πÅ‡∏•‡∏∞ 'Name-surname')
    prog_info = df_master.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£").agg(
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå=("Name-surname", "nunique"),
        ‡∏Ñ‡∏ì‡∏∞=("‡∏Ñ‡∏ì‡∏∞", "first")
    ).reset_index()
    
    # ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ research
    res_score = df_research.merge(df_master[['Name-surname', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£']], 
                                   left_on="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", right_on="Name-surname", how="left")
    res_sum = res_score.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£")["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"].sum().reset_index()
    
    # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    report = prog_info.merge(res_sum, on="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", how="left").fillna(0)
    
    # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì KPI ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    def calc_kpi(row):
        p = row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]
        n = row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå"]
        # ‡∏Ñ‡πà‡∏≤ X ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        group_40 = ["G-Dip TH", "G-Dip Inter", "M. Ed-Admin", "M. Ed-LMS", "MBA", "MPH"]
        x_val = 60 if p == "Ph.D-Admin" else (40 if p in group_40 else 20)
        
        score = (((row["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"] / n) * 100) / x_val) * 5
        return round(min(score, 5.0), 2)

    report["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI"] = report.apply(calc_kpi, axis=1)
    
    # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á
    fig = px.bar(report.sort_values("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI"), x="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI", y="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", color="‡∏Ñ‡∏ì‡∏∞",
                 orientation='h', height=700)
    fig.add_vline(x=5.0, line_dash="dash", line_color="red", annotation_text="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 5.0")
    st.plotly_chart(fig, use_container_width=True)
    
    st.dataframe(report[["‡∏Ñ‡∏ì‡∏∞", "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI"]], use_container_width=True)

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô ---
else:
    st.title("‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà")
    with st.form("input_form"):
        t = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á")
        a = st.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", df_master["Name-surname"].unique())
        j = st.selectbox("‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£", ["TCI1", "TCI2", "Scopus Q1", "Scopus Q2", "Scopus Q3", "Scopus Q4"])
        y = st.number_input("‡∏õ‡∏µ ‡∏û.‡∏®.", 2567, 2600, 2568)
        
        if st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"):
            if t and a:
                # Logic ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)")
