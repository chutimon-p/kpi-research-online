import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import plotly.express as px

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢", layout="wide")

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á CSS
st.markdown("""
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; }
        .stMetric { background-color: #f0f2f6; padding: 10px; border-radius: 10px; }
    </style>
""", unsafe_allow_html=True)

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
conn = st.connection("gsheets", type=GSheetsConnection)

@st.cache_data(ttl=0)
def load_data():
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ Worksheet (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Google Sheets ‡∏ß‡πà‡∏≤ masters ‡πÅ‡∏•‡∏∞ research)
        df_m = conn.read(worksheet="masters")
        df_r = conn.read(worksheet="research")
        
        # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        df_m.columns = df_m.columns.str.strip()
        df_r.columns = df_r.columns.str.strip()
            
        return df_m, df_r
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")
        st.info("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô Google Sheets ‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô (Tab) ‡∏ä‡∏∑‡πà‡∏≠ 'masters' ‡πÅ‡∏•‡∏∞ 'research' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Secrets ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")
        st.stop()

df_master, df_research = load_data()

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
if 'Name-surname' not in df_master.columns:
    st.error(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'Name-surname' ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ masters")
    st.stop()

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏ô‡∏π Sidebar ---
with st.sidebar:
    st.title("üìå ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö")
    menu = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠", ["üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI", "‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô"])
    st.divider()
    
    # ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ research
    if not df_research.empty and '‡∏õ‡∏µ' in df_research.columns:
        all_years = sorted(df_research["‡∏õ‡∏µ"].dropna().unique().astype(int).tolist())
        year_option = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®.", ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + [str(y) for y in all_years])
    else:
        year_option = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"

# --- 4. ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI ---
if menu == "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI":
    st.title(f"üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏õ‡∏µ {year_option}")
    
    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
    df_filtered = df_research.copy()
    if year_option != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
        df_filtered = df_filtered[df_filtered["‡∏õ‡∏µ"] == int(year_option)]

    # ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
    all_progs = df_master[df_master["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"].notna() & (df_master["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"] != "-")]["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"].unique()
    prog_df = pd.DataFrame(all_progs, columns=["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"])
    
    fac_map = df_master.drop_duplicates("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£").set_index("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£")["‡∏Ñ‡∏ì‡∏∞"].to_dict()
    prog_df["‡∏Ñ‡∏ì‡∏∞"] = prog_df["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"].map(fac_map)
    
    # ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    df_merged = df_filtered.merge(df_master[['Name-surname', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£']], left_on="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", right_on="Name-surname", how="left")
    res_agg = df_merged.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£")["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"].sum().reset_index()
    prog_df = prog_df.merge(res_agg, on="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", how="left").fillna(0)
    
    # ‡∏™‡∏π‡∏ï‡∏£ KPI (‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ masters)
    staff_counts = df_master.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£")["Name-surname"].nunique().to_dict()
    
    def calc_kpi(row):
        p = row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]
        n = staff_counts.get(p, 1)
        # ‡∏Ñ‡πà‡∏≤ X ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        group_40 = ["G-Dip TH", "G-Dip Inter", "M. Ed-Admin", "M. Ed-LMS", "MBA", "MPH"]
        x_val = 60 if p == "Ph.D-Admin" else (40 if p in group_40 else 20)
        score = (((row["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"] / n) * 100) / x_val) * 5
        return round(min(score, 5.0), 2)

    prog_df["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI"] = prog_df.apply(calc_kpi, axis=1)
    prog_df = prog_df.sort_values("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI", ascending=False)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    fig = px.bar(prog_df, x="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI", y="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", color="‡∏Ñ‡∏ì‡∏∞", 
                 orientation='h', height=800, text="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI")
    fig.add_vline(x=5.0, line_dash="dash", line_color="red", annotation_text="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 5.0")
    st.plotly_chart(fig, use_container_width=True)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    st.dataframe(prog_df, use_container_width=True)

# --- 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô ---
else:
    st.title("‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà")
    st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô 'research' ‡πÉ‡∏ô Google Sheets ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á")
    
    with st.form("research_form", clear_on_submit=True):
        col1, col2 = st.columns([3, 1])
        with col1:
            new_title = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢")
        with col2:
            new_year = st.number_input("‡∏õ‡∏µ ‡∏û.‡∏®. (‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå)", 2560, 2600, 2568)
            
        col3, col4 = st.columns(2)
        with col3:
            # ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            score_map = {
                "TCI 1": 0.8, "TCI 2": 0.6, 
                "Scopus Q1": 1.0, "Scopus Q2": 1.0, 
                "Scopus Q3": 1.0, "Scopus Q4": 1.0
            }
            new_journal = st.selectbox("‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£ / ‡∏£‡∏∞‡∏î‡∏±‡∏ö", list(score_map.keys()))
        with col4:
            # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏à‡∏≤‡∏Å masters ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            author_list = sorted(df_master["Name-surname"].dropna().unique().tolist())
            selected_authors = st.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå)", author_list)
            
        new_external = st.text_input("‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)")

        if st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheets"):
            if new_title and selected_authors:
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                new_entries = []
                for author in selected_authors:
                    new_entries.append({
                        "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á": new_title,
                        "‡∏õ‡∏µ": new_year,
                        "‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£": new_journal,
                        "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": score_map[new_journal],
                        "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô": author,
                        "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å": new_external
                    })
                
                # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà
                new_data_df = pd.DataFrame(new_entries)
                updated_research = pd.concat([df_research, new_data_df], ignore_index=True)
                
                # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheets
                conn.update(worksheet="research", data=updated_research)
                
                st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                st.balloons()
                # ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                st.cache_data.clear()
            else:
                st.error("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡πà‡∏≤‡∏ô")
