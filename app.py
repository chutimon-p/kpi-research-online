import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import plotly.express as px
import plotly.graph_objects as go

# ==========================================
# 1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Database Connection)
# ==========================================
@st.cache_resource
def conn_sheets():
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    try:
        creds_dict = st.secrets["gcp_service_account"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        return client
    except Exception as e:
        st.error(f"‚ùå Connection Failed: {e}")
        return None

def load_sheet_data(sheet_name):
    client = conn_sheets()
    if client:
        try:
            sh = client.open("Research_Database") 
            worksheet = sh.worksheet(sheet_name)
            data = worksheet.get_all_records()
            df = pd.DataFrame(data)
            df.columns = df.columns.str.strip() 
            return df
        except Exception as e:
            st.error(f"‚ùå Cannot load '{sheet_name}': {e}")
            return pd.DataFrame()
    return pd.DataFrame()

# ==========================================
# 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
# ==========================================

# ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£ n)
FIXED_PROG_MEMBERS = {
    "BE": 5, "CA": 5, "B.Ed-Math": 5, "B.Ed-Sci": 5, "B.Ed-Eng": 5, "B.Ed-EC": 5,
    "G-Dip TH": 5, "G-Dip Inter": 5, "M.Ed-Admin": 3, "M.Ed-LMS": 3, "Ph.D-Admin": 3,
    "BBA": 9, "ACC": 5, "AB": 5, "ATC": 5, "AR": 5, "MBA": 3,
    "PH": 5, "OHS": 5, "MPH": 3, "NS": 5
}

# ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞ (‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£ n)
FIXED_FAC_MEMBERS = {
    "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 15,
    "‡∏Ñ‡∏ì‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 42,
    "‡∏Ñ‡∏ì‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï": 40,
    "‡∏Ñ‡∏ì‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç": 18,
    "‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 15
}

SCORE_MAP = {"TCI1": 0.8, "TCI2": 0.6, "Scopus Q1": 1.0, "Scopus Q2": 1.0, "Scopus Q3": 1.0, "Scopus Q4": 1.0}

# ==========================================
# 3. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå
# ==========================================
st.set_page_config(page_title="Research KPI Dashboard", layout="wide")

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
    html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; }
    [data-testid="stMetricValue"] { color: #1E3A8A; }
    </style>
    """, unsafe_allow_html=True)

st.title("üìä Research KPI Performance (Fixed Multiplier)")

# Load Data
df_master = load_sheet_data("masters")
df_research = load_sheet_data("research")

if df_master.empty or df_research.empty:
    st.warning("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...")
    st.stop()

# Cleaning Data
df_research['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'] = pd.to_numeric(df_research['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'], errors='coerce').fillna(0.0)
df_research['‡∏õ‡∏µ'] = pd.to_numeric(df_research['‡∏õ‡∏µ'], errors='coerce').fillna(0).astype(int)

# ==========================================
# 4. ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sidebar)
# ==========================================
all_years = sorted(df_research[df_research["‡∏õ‡∏µ"] > 0]["‡∏õ‡∏µ"].unique().tolist())
year_option = st.sidebar.selectbox("üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏û.‡∏®.):", ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + [str(y) for y in all_years])

df_filtered = df_research.copy()
if year_option != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
    df_filtered = df_filtered[df_filtered["‡∏õ‡∏µ"] == int(year_option)]

# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
df_full_info = df_filtered.merge(df_master[['Name-surname', '‡∏Ñ‡∏ì‡∏∞', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£']], left_on="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", right_on="Name-surname", how="left")

# ==========================================
# 5. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard
# ==========================================
t1, t2, t3 = st.tabs(["üéì KPI ‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", "üè¢ KPI ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ì‡∏∞", "üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö"])

with t1:
    st.markdown(f"### ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏õ‡∏µ {year_option}")
    
    # --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞: 1 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏±‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ---
    prog_dedup = df_full_info.drop_duplicates(subset=['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'])
    
    prog_summary = prog_dedup.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£").agg(
        Total_Score=("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "sum"), 
        Total_Titles=("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "count")
    ).reset_index()
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
    prog_report = pd.DataFrame(list(FIXED_PROG_MEMBERS.keys()), columns=["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"])
    prog_report = prog_report.merge(prog_summary, on="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", how="left").fillna(0)

    def calc_prog_kpi(row):
        n = FIXED_PROG_MEMBERS.get(row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"], 1)
        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Target (x)
        group_40 = ["G-Dip TH", "G-Dip Inter", "M.Ed-Admin", "M.Ed-LMS", "MBA", "MPH"]
        x = 60 if row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"] == "Ph.D-Admin" else (40 if row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"] in group_40 else 20)
        
        # ‡∏™‡∏π‡∏ï‡∏£: ((‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏° / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå) * 100) / x * 5
        score = (((row["Total_Score"] / n) * 100) / x) * 5
        return round(score, 2)

    prog_report["KPI_Score"] = prog_report.apply(calc_prog_kpi, axis=1)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    fig_prog = px.bar(prog_report.sort_values("KPI_Score"), 
                      x="KPI_Score", y="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", orientation='h', 
                      text="KPI_Score", title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô KPI ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£",
                      color="KPI_Score", color_continuous_scale="RdYlGn")
    st.plotly_chart(fig_prog, use_container_width=True)
    
    st.dataframe(prog_report.sort_values("KPI_Score", ascending=False), use_container_width=True, hide_index=True)

with t2:
    st.markdown(f"### ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ì‡∏∞ ‡∏õ‡∏µ {year_option}")
    
    # --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞: 1 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏±‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ì‡∏∞ ---
    fac_dedup = df_full_info.drop_duplicates(subset=['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏Ñ‡∏ì‡∏∞'])
    
    fac_summary = fac_dedup.groupby("‡∏Ñ‡∏ì‡∏∞").agg(
        Total_Score=("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "sum"), 
        Total_Titles=("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "count")
    ).reset_index()
    
    fac_report = pd.DataFrame(list(FIXED_FAC_MEMBERS.keys()), columns=["‡∏Ñ‡∏ì‡∏∞"])
    fac_report = fac_report.merge(fac_summary, on="‡∏Ñ‡∏ì‡∏∞", how="left").fillna(0)

    def calc_fac_kpi(row):
        n = FIXED_FAC_MEMBERS.get(row["‡∏Ñ‡∏ì‡∏∞"], 1)
        y = 30 if row["‡∏Ñ‡∏ì‡∏∞"] in ["‡∏Ñ‡∏ì‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç", "‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"] else 20
        score = (((row["Total_Score"] / n) * 100) / y) * 5
        return round(score, 2)

    fac_report["Faculty_KPI"] = fac_report.apply(calc_fac_kpi, axis=1)
    
    fig_fac = px.bar(fac_report.sort_values("Faculty_KPI"), 
                     x="Faculty_KPI", y="‡∏Ñ‡∏ì‡∏∞", orientation='h', 
                     text="Faculty_KPI", color="Faculty_KPI",
                     template="plotly_white")
    st.plotly_chart(fig_fac, use_container_width=True)
    st.dataframe(fac_report, use_container_width=True, hide_index=True)

with t3:
    st.markdown("### ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£)")
    st.dataframe(df_master, use_container_width=True)
