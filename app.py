import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import plotly.express as px
from datetime import datetime

# ==========================================
# 1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets (Core)
# ==========================================
@st.cache_resource
def conn_sheets():
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    try:
        creds_dict = st.secrets["gcp_service_account"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        client = gspread.authorize(creds)
        return client
    except Exception as e:
        st.error(f"‚ùå Connection Failed: {e}")
        return None

def load_sheet_data(sheet_name):
    client = conn_sheets()
    if client:
        try:
            sh = client.open("Research_Database") 
            worksheet = sh.worksheet(sheet_name)
            data = worksheet.get_all_records()
            df = pd.DataFrame(data)
            df.columns = df.columns.str.strip() 
            return df
        except Exception as e:
            st.error(f"‚ùå Cannot load '{sheet_name}': {e}")
            return pd.DataFrame()
    return pd.DataFrame()

def save_to_sheet(sheet_name, new_row_list):
    client = conn_sheets()
    if client:
        try:
            sh = client.open("Research_Database")
            worksheet = sh.worksheet(sheet_name)
            worksheet.append_row(new_row_list)
            return True
        except: return False
    return False

# ==========================================
# 2. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Excel ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û Masters)
# ==========================================
FIXED_PROG_MEMBERS = {
    "BE": 5, "CA": 5, "B.Ed-Math": 5, "B.Ed-Sci": 5, "B.Ed-Eng": 5, "B.Ed-EC": 5,
    "G-Dip TH": 5, "G-Dip Inter": 5, "M.Ed-Admin": 3, "M.Ed-LMS": 3, "Ph.D-Admin": 3,
    "BBA": 9, "ACC": 5, "AB": 5, "ATC": 5, "AR": 5, "MBA": 3,
    "PH": 5, "OHS": 5, "MPH": 3, "NS": 5
}

FIXED_FAC_MEMBERS = {
    "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 15,
    "‡∏Ñ‡∏ì‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 42,
    "‡∏Ñ‡∏ì‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï": 40,
    "‡∏Ñ‡∏ì‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 18,
    "‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå": 15
}

SCORE_MAP = {"TCI1": 0.8, "TCI2": 0.6, "Scopus Q1": 1.0, "Scopus Q2": 1.0, "Scopus Q3": 1.0, "Scopus Q4": 1.0}

# ==========================================
# 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ==========================================
st.set_page_config(page_title="Research Management - STIU", layout="wide")

df_master = load_sheet_data("masters")
df_research = load_sheet_data("research")

if df_master.empty or df_research.empty:
    st.warning("‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    st.stop()

# Clean Data ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 87 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
df_research['‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô'] = df_research['‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô'].astype(str).str.strip()
df_master['Name-surname'] = df_master['Name-surname'].astype(str).str.strip()
df_research['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'] = pd.to_numeric(df_research['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'], errors='coerce').fillna(0.0)
df_research['‡∏õ‡∏µ'] = pd.to_numeric(df_research['‡∏õ‡∏µ'], errors='coerce').fillna(0).astype(int)

# ==========================================
# 4. Sidebar ‡πÄ‡∏°‡∏ô‡∏π (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°)
# ==========================================
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False

with st.sidebar:
    st.title("üìå Menu")
    menu_list = ["üìä Dashboard & Reports"]
    if st.session_state.logged_in:
        menu_list.insert(0, "‚úçÔ∏è Submit Research")
        menu_list.append("‚öôÔ∏è Manage Database")
    
    menu = st.radio("Go to Page:", menu_list)
    
    st.divider()
    # Login Section
    if not st.session_state.logged_in:
        pwd = st.text_input("Admin Password", type="password")
        if st.button("Login"):
            if pwd == st.secrets.get("ADMIN_PASSWORD"):
                st.session_state.logged_in = True
                st.rerun()
    else:
        if st.button("Logout"):
            st.session_state.logged_in = False
            st.rerun()

# ==========================================
# 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤ Dashboard
# ==========================================
if menu == "üìä Dashboard & Reports":
    st.header("üìä Research Dashboard")
    
    # ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ
    all_years = sorted(df_research[df_research["‡∏õ‡∏µ"] > 0]["‡∏õ‡∏µ"].unique().tolist())
    year_choice = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ ‡∏û.‡∏®.:", ["All Years"] + [str(y) for y in all_years])
    
    df_filtered = df_research.copy()
    if year_choice != "All Years":
        df_filtered = df_filtered[df_filtered["‡∏õ‡∏µ"] == int(year_choice)]
    
    # Merge ‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£/‡∏Ñ‡∏ì‡∏∞
    df_full = df_filtered.merge(df_master[['Name-surname', '‡∏Ñ‡∏ì‡∏∞', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£']], left_on="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", right_on="Name-surname", how="left")
    
    # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Mismatch (87 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    mismatch = df_full[df_full['‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'].isna()]
    if not mismatch.empty:
        st.error(f"‚ö†Ô∏è ‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢ {len(mismatch)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master")
        with st.expander("‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô Google Sheets"):
            st.table(mismatch[['‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á']].drop_duplicates().head(20))

    tab1, tab2, tab3 = st.tabs(["üéì Program KPI", "üè¢ Faculty KPI", "üìã Data Table"])

    with tab1:
        prog_unique = df_full.drop_duplicates(subset=['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'])
        prog_sum = prog_unique.groupby("‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£").agg(Total_Score=("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "sum")).reset_index()
        report_p = pd.DataFrame(list(FIXED_PROG_MEMBERS.keys()), columns=["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"])
        report_p = report_p.merge(prog_sum, on="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", how="left").fillna(0)

        def calc_p(row):
            n = FIXED_PROG_MEMBERS.get(row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"], 1)
            group_40 = ["G-Dip TH", "G-Dip Inter", "M.Ed-Admin", "M.Ed-LMS", "MBA", "MPH"]
            x = 60 if row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"] == "Ph.D-Admin" else (40 if row["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"] in group_40 else 20)
            return round((((row["Total_Score"] / n) * 100) / x) * 5, 2)

        report_p["KPI Score"] = report_p.apply(calc_p, axis=1)
        st.plotly_chart(px.bar(report_p.sort_values("KPI Score"), x="KPI Score", y="‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£", orientation='h', text="KPI Score", height=600))

    with tab2:
        fac_unique = df_full.drop_duplicates(subset=['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏Ñ‡∏ì‡∏∞'])
        fac_sum = fac_unique.groupby("‡∏Ñ‡∏ì‡∏∞").agg(Total_Score=("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "sum")).reset_index()
        report_f = pd.DataFrame(list(FIXED_FAC_MEMBERS.keys()), columns=["‡∏Ñ‡∏ì‡∏∞"])
        report_f = report_f.merge(fac_sum, on="‡∏Ñ‡∏ì‡∏∞", how="left").fillna(0)

        def calc_f(row):
            n = FIXED_FAC_MEMBERS.get(row["‡∏Ñ‡∏ì‡∏∞"], 1)
            y = 30 if row["‡∏Ñ‡∏ì‡∏∞"] in ["‡∏Ñ‡∏ì‡∏∞‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"] else 20
            return round((((row["Total_Score"] / n) * 100) / y) * 5, 2)

        report_f["Faculty Score"] = report_f.apply(calc_f, axis=1)
        st.plotly_chart(px.bar(report_f, x="Faculty Score", y="‡∏Ñ‡∏ì‡∏∞", orientation='h', text="Faculty Score"))

    with tab3:
        st.dataframe(df_full, use_container_width=True)

# ==========================================
# 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Submit Research
# ==========================================
elif menu == "‚úçÔ∏è Submit Research":
    st.header("‚úçÔ∏è Submit New Research")
    with st.form("research_form"):
        title = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Research Title)")
        year = st.number_input("‡∏õ‡∏µ (‡∏û.‡∏®.)", min_value=2560, max_value=2570, value=2567)
        source = st.selectbox("‡∏ê‡∏≤‡∏ô‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£", list(SCORE_MAP.keys()))
        author = st.selectbox("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Master)", sorted(df_master['Name-surname'].tolist()))
        
        if st.form_submit_button("Submit"):
            score = SCORE_MAP[source]
            new_data = [title, year, source, score, author]
            if save_to_sheet("research", new_data):
                st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                st.rerun()
            else:
                st.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

# ==========================================
# 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Manage Database
# ==========================================
elif menu == "‚öôÔ∏è Manage Database":
    st.header("‚öôÔ∏è Manage Research Records")
    st.write("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)")
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Index ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    df_manage = df_research.copy()
    df_manage['ID'] = range(2, len(df_manage) + 2) # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß 2 ‡πÉ‡∏ô Google Sheets
    
    st.dataframe(df_manage, use_container_width=True)
    
    row_to_delete = st.number_input("‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)", min_value=2, step=1)
    if st.button("üóë ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ"):
        client = conn_sheets()
        if client:
            sh = client.open("Research_Database")
            ws = sh.worksheet("research")
            ws.delete_rows(int(row_to_delete))
            st.success(f"‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà {row_to_delete} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            st.rerun()
